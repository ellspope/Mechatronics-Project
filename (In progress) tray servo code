#include "xc.h"

#pragma config FNOSC = LPFRC //choose the internal 500 kHz oscillator
#pragma config OSCIOFNC = OFF   // Turn off clock output on pin 8
#pragma config SOSCSRC = DIG    // Turn off secondary oscillator on pins 9&10

// Duty cycle (pulse width) determines angle of the servo motor


int main(void) {
    // Configure oscillator postscaler. We don't need any postscaler, but 
    //default is divide by 2.
    _RCDIV = 0b000; // divide by 1 > F_OSC=500 kHz
    
    // Configure PWM for pin 5
    OC3CON1 = 0;                // Clear all bits of OC3CON1
    OC3CON2 = 0;                // Clear all bits of OC3CON2
    OC3CON1bits.OCTSEL = 0b111; // System clock as timing source
    OC3CON2bits.SYNCSEL = 0x1F; // Self-synchronization
    OC3CON2bits.OCTRIG = 0;     // Synchronization mode
    OC3CON1bits.OCM = 0b110;    // Edge-aligned PWM mode
    
     // Configure Timer1
    _TON = 1; // Turn Timer1 on
    _TCS = 0; // Internal clock source (F_OSC/2)
    _TCKPS = 0b10; // 1:64 prescaling
    PR1 = 35156; // Set period register to 9s. Timer resets at 9s. 
    TMR1 = 0; // Reset Timer1
    
    OC3RS = 4999; // 50 Hz PWM frequency
    // OC3R values for angles:
    // 125: 0
    // 425: 90
    // 625: 180
    while(1) {
        if(TMR1 < 7813) { // 7813 = counts to get to 2s
            OC3R = 425; // 90 deg 
        }
        else if(TMR1 > 7813 && TMR1 < 19531) { // 19531 = counts to get to 5s
            OC3R = 425; // 90 deg
        }
        else if (TMR1 > 19531){
            OC3R = 125; // 0 deg
        }
    }
    
    return 0;
}
